<?php
	private function parsePost ($node)
	{
		return $this->xmlDump('post', $_POST);
	}
	
	private function parseGet ($node) {
		return $this->xmlDump('get', $_GET);
	}
	
	private function xmlDump($name, $arr)
	{
		$result = $this -> makeNode ($name);
			if (!empty ($arr)) {
				foreach ($arr as $key => $pst) {
					if (strlen ($pst))
						if(!is_array($pst))
						{
							$pst = array($pst);
						}
						foreach($pst as $val)
						{
							$result -> appendChild ($this -> makeNode ($key, $val));
						}
				}	
			}
		return $result;
	}

	private function parsePath ($node) {
		$path = $this -> dom -> createElement('path');
		$req = $this -> dom -> createAttribute('request');
		$req -> nodeValue = $this -> request;
		$path -> appendChild( $req );
		if (count($this -> path))
		foreach( $this -> path as $p )
		{
			$path -> appendChild( $this -> dom -> createElement('dir', $p) );
		}
		return $path;
	}
		
	private function parseVar ($node)
	{
		if (!$this -> validateAction ($node)) return  $this -> simpleError ($node -> nodeName, 'invalid action');		
		if (!$node -> hasAttribute ('name')) return $this -> simpleError ('var', '@name is not defined');
		$var_name = $node -> getAttribute ('name');
		preg_match('/'.$this->registered.'\:([a-zA-Z0-9\_]+)/', $var_name, $result);
		$type = $result[1];
		$name = $result[2];
		
		if ($node -> hasAttribute ('value')) 
		{
			$var_value = $node -> getAttribute ('value');
			$value = $this -> value ($var_value);
		}
		
		if(isset($value))
		{
			$var = $this -> appendValue($type, $name, $value);
		}
		else
		{
			$value = $this -> extractValue($type, $name);
		}

		if($node -> hasChildNodes())
		{
			$values = split('(^\'|\',\'|\'$)', $value);
			foreach($values as $val)
			{
				if(strlen($val))
				{
					$tmp = $var -> appendChild($this -> appendValue($type, $name, $val));
					foreach($node -> childNodes as $child)
					{
						$clone = $tmp -> appendChild($child -> cloneNode(true));
					}
					$this -> parse($tmp);
				}
			}
		}
		
		return $var;
	}
	
	private function appendValue($type, $name, $value)
	{
		if($type === 'post') $_POST[$name] = $value;
		if($type === 'get') $_GET[$name] = $value;
		if($type === 'session') $_SESSION[$name] = $value;
		if($type === 'cookie') $_COOKIE[$name] = $value;
		if($type === 'globals') $this->globals[$name] = $value;
		$var = $this -> dom -> createElement ('var', $value);
		$var -> setAttribute ('name', $name);
		$var -> setAttribute ('type', $type);
		return $var;
	}
	private function extractValue($type, $name)
	{
		$value = null;
		if($type === 'post') $value = $_POST[$name];
		if($type === 'get') $value = $_GET[$name];
		if($type === 'session') $value = $_SESSION[$name];
		if($type === 'cookie') $value = $_COOKIE[$name];
		if($type === 'globals') $value = $this->globals[$name];
		$var = $this -> dom -> createElement ('var', $value);
		$var -> setAttribute ('name', $name);
		$var -> setAttribute ('type', $type);
		return $var;
	}
?>
